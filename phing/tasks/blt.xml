<project name="blt" default="update">
  <target name="init">
    <echo>Copying BLT files into place.</echo>
    <!-- @todo Do not overwrite structured or executable files. Instead, update them intelligently. composer.json, project.yml, settings.php, drush.wrapper etc. -->
    <exec dir="${repo.root}" command="rsync -a --no-g --no-p --update ${blt.root}/template/ ${repo.root}/ --filter 'protect /.git/' -v" logoutput="true" checkreturn="true"/>

    <echo>Please customize ${repo.root}/project.yml and then run:</echo>
    <echo>blt configure</echo>
  </target>

  <target name="update" depends="init, configure">
    <!-- @todo Ignore some files, settings.php, project.yml, in update. Instead, change only specific values. -->
  </target>

  <target name="configure">
    <echo>Expanding Phing properties in BLT files.</echo>
    <!-- Reflexively expand properties in specified dirs/files. -->
    <reflexive>
      <fileset dir="${repo.root}">
        <include name="composer.json" />
        <include name="README.md" />
        <include name="readme/**/*" />
        <include name="docroot/profiles/custom/**/*" />
        <include name="docroot/sites/default/settings.php" />
        <include name="docroot/sites/all/settings/**/*" />
      </fileset>
      <filterchain>
        <expandproperties />
      </filterchain>
    </reflexive>
  </target>

  <target name="blt:alias" description="Installs the BLT alias for command line usage.">
    <if>
      <not><equals arg1="${create_alias}" arg2="false"/></not>
      <then>
        <exec dir="${blt.root}/scripts/blt" command="./install-alias.sh" passthru="true" checkreturn="true"/>
      </then>
    </if>
  </target>

  <!-- This target is meant to test BLT itself on TravisCI.
       A few things to note:
       - We do not run validate:* targets, since they can be run in parallel.
  -->
  <target name="self-test" description="Runs tests against acquia/blt proper.">
    <phingcall target="configure" />
    <phingcall target="create" />
    <phingcall target="setup:build" />
    <phingcall target="setup:drupal:install" />
    <phingcall target="setup:git-hooks" />
    <phingcall target="setup:behat" />
    <phingcall target="tests:security-updates" />
    <phingcall target="tests:behat" />
    <phingcall target="tests:phpunit" />
  </target>
</project>
